<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.ssafy.bbb.model.dao.ProductDao">
  	<insert id="save" useGeneratedKeys="true" keyProperty="productId">
  		insert into products(jibun, house_type, trade_type, status, name, build_year, exclu_use_ar, apt_dong, floor, land_ar, total_floor_ar, plottage_ar, deal_amount, deposit, monthly_rent, sgg_cd, umd_nm, agent_id)
  		values(#{jibun}, #{houseType}, #{tradeType}, #{status}, #{name}, #{buildYear}, #{excluUseAr}, #{aptDong}, #{floor}, #{landAr}, #{totalFloorAr}, #{plottageAr}, #{dealAmount}, #{deposit}, #{monthlyRent}, #{sggCd}, #{umdNm}, #{agentId});
  	</insert>
  	
  	<update id="update">
  		update products
  		<set> 
	  		jibun=#{product.jibun},
	  		house_type=#{product.houseType}, 
	  		trade_type=#{product.tradeType}, 
	  		status=#{product.status},
	  		name=#{product.name}, 
	  		build_year=#{product.buildYear}, 
	  		exclu_use_ar=#{product.excluUseAr}, 
	  		apt_dong=#{product.aptDong}, 
	  		floor=#{product.floor}, 
	  		land_ar=#{product.landAr}, 
	  		total_floor_ar=#{product.totalFloorAr}, 
	  		plottage_ar=#{product.plottageAr}, 
	  		deal_amount=#{product.dealAmount}, 
	  		deposit=#{product.deposit}, 
	  		monthly_rent=#{product.monthlyRent}, 
	  		sgg_cd=#{product.sggCd}, 
	  		umd_nm=#{product.umdNm}, 
	  		agent_id=#{product.agentId},
  		</set>
  		where product_id = #{id};
  	</update>
  	
  	<select id="findById">
  		select * from products
  		where product_id = #{id};
  	</select>
  	
  	<select id="findImagesByProductId">
  		select * from product_images
  		where product_id = #{productId};
  	</select>
  	
  	<insert id="saveImages">
  		insert into product_images (product_id, original_name, save_name, save_path)
  		values
  		<foreach collection="imageDtos" item="image" separator=",">
  			(#{image.productId}, #{image.originalName}, #{image.saveName}, #{image.savePath})
  		</foreach>
  		;
  	</insert>
  	
  	<delete id="deleteImages">
  		delete from product_images
  		where image_id in
  		<foreach collection="imageIds" item="id" open="(" close=")" separator=",">
  			#{id}
  		</foreach>
  		;
  	</delete>
  	
  	<select id="findSavePathByIds">
  		select save_path from product_images
  		where image_id in
  		<foreach collection="imageIds" item="id" open="(" close=")" separator=",">
  			#{id}
  		</foreach>
  		;
  	</select>
  	
  	<select id="selectProductForUpdate" resultMap="selectProductMap">
  		select agent_id, status from products
  		where product_id = #{productId}
  		for update;
  	</select>
  	
  	<update id="updateProductStatus">
  		update products
  		set status = #{status}
  		where product_id = #{productId}
  	</update>
  	
  	<resultMap type="map" id="selectProductMap">
  		<id column="product_id" property="productId" />
  		<result column="agent_id" property="agentId" />
  		<result column="status" property="status" />
  	</resultMap>
  	
  </mapper>