<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.ssafy.bbb.model.dao.ProductDao">
  	<insert id="save" useGeneratedKeys="true" keyProperty="productId">
  		insert into products(jibun, house_type, trade_type, name, build_year, exclu_use_ar, apt_dong, floor, land_ar, total_floor_ar, plottage_ar, deal_amount, deposit, monthly_rent, sgg_cd, umd_nm, agent_id)
  		values(#{jibun}, #{houseType}, #{tradeType}, #{name}, #{buildYear}, #{excluUseAr}, #{aptDong}, #{floor}, #{landAr}, #{totalFloorAr}, #{plottageAr}, #{dealAmount}, #{deposit}, #{monthlyRent}, #{sggCd}, #{umdNm}, #{agentId});
  	</insert>
  	
  	<update id="update">
  		update products
  		<set> 
	  		jibun=#{product.jibun},
	  		house_type=#{product.houseType}, 
	  		trade_type=#{product.tradeType}, 
	  		name=#{product.name}, 
	  		build_year=#{product.buildYear}, 
	  		exclu_use_ar=#{product.excluUseAr}, 
	  		apt_dong=#{product.aptDong}, 
	  		floor=#{product.floor}, 
	  		land_ar=#{product.landAr}, 
	  		total_floor_ar=#{product.totalFloorAr}, 
	  		plottage_ar=#{product.plottageAr}, 
	  		deal_amount=#{product.dealAmount}, 
	  		deposit=#{product.deposit}, 
	  		monthly_rent=#{product.monthlyRent}, 
	  		sgg_cd=#{product.sggCd}, 
	  		umd_nm=#{product.umdNm}, 
	  		agent_id=#{product.agentId},
  		</set>
  		where product_id = #{id};
  	</update>
  	
  	<select id="findById">
  		select * from products
  		where product_id = #{id};
  	</select>
  	
  	<select id="findImagesByProductId">
  		select * from product_images
  		where product_id = #{productId};
  	</select>
  	
  	<insert id="saveImages">
  		insert into product_images (product_id, original_name, save_name, save_path)
  		values
  		<foreach collection="imageDtos" item="image" separator=",">
  			(#{image.productId}, #{image.originalName}, #{image.saveName}, #{image.savePath})
  		</foreach>
  		;
  	</insert>
  	
  	<delete id="deleteImages">
  		delete from product_images
  		where image_id in
  		<foreach collection="imageIds" item="id" open="(" close=")" separator=",">
  			#{id}
  		</foreach>
  		;
  	</delete>
  	
  	<select id="findSavePathByIds">
  		select save_path from product_images
  		where image_id in
  		<foreach collection="imageIds" item="id" open="(" close=")" separator=",">
  			#{id}
  		</foreach>
  		;
  	</select>
  	
  	<select id="search" parameterType="com.ssafy.bbb.model.dto.ProductSearchDto">
  		select *
  		from products
  		<where>
  			<if test="keyword != null and keyword != ''">
  				and (
  					name like concat('%', #{keyword}, '%')
  					or jibun like concat('%', #{keyword}, '%')
  					or apt_dong like concat('%', #{keyword}, '%')
  				)
  			</if>
  			
  			<if test="houseType != null and houseType != ''">
  				and house_type = #{houseType}
  			</if>
  			
  			<if test="tradeType != null and tradeType != '' and tradeType != '전체'">
  				and trade_type = #{tradeType}
  			</if>
  			
  			<if test="excluUseAr != null and excluUseAr != '' and excluUseAr != '전체 면적'">
  				<choose>
  					<when test="excluUseAr == '33㎡ 이하 (약 10평)'">
  						and exclu_use_ar &lt;= 33
  					</when>
  					
  					<when test="excluUseAr == '33㎡ ~ 66㎡ (10~20평)'">
  						AND exclu_use_ar &gt; 33 AND exclu_use_ar &lt;= 66
  					</when>
  					
  					<when test="excluUseAr == '66㎡ ~ 99㎡ (20~30평)'">
  						AND exclu_use_ar &gt; 66 AND exclu_use_ar &lt;= 99
  					</when>
  					
  					<when test="excluUseAr == '99㎡ 이상 (30평대~)'">
  						and exclu_use_ar &gt; 99
  					</when>
  				</choose>
  			</if>
  			
			<if test="floor != null and floor != '' and floor != '전체'">
            	<choose>
                	<when test="floor == '1층'">
                    	AND (floor = '1층' OR floor = '1') 
                	</when>
                
                	<when test="floor == '2층'">
                    	AND (floor = '2층' OR floor = '2')
                	</when>
                
                	<when test="floor == '반지하'">
                    	AND floor LIKE '%지하%'
                	</when>
                
                	<when test="floor == '옥탑'">
                    	AND floor LIKE '%옥탑%'
                	</when>
                
                	<when test="floor == '3층 이상'">
                    	AND floor != '1층' AND floor != '1'
	                    AND floor != '2층' AND floor != '2'
        	            AND floor NOT LIKE '%지하%'
            	        AND floor NOT LIKE '%옥탑%'
                	</when>
            	</choose>
        	</if>
  		</where>
  	</select>
  	
  </mapper>