<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.ssafy.bbb.model.dao.PostDao">
  
  	<sql id="searchCondition">
  		<if test="search.keyword != null and search.keyword != ''">
			AND (
				p.title like concat('%', #{search.keyword}, '%')
				OR p.content like concat('%', #{search.keyword}, '%')
			)
		</if>
		
		<if test="search.sidoNm != null and search.sidoNm != '전체'">
			AND p.sido_nm = #{search.sidoNm}
		</if>
		
		<if test="search.sggNm != null and search.sggNm != '전체'">
			AND p.sgg_nm = #{search.sggNm}
		</if>
  	</sql>
  	
  	<insert id="insert" parameterType="com.ssafy.bbb.model.dto.notice.PostRequestDto" useGeneratedKeys="true" keyProperty="postId">
  		INSERT INTO posts(user_id, title, content, sido_nm, sgg_nm, created_at, last_modified_at)
  		VALUES(#{userId}, #{title}, #{content}, #{sidoNm}, #{sggNm}, NOW(), NOW())
  	</insert>
  	
  	<select id="postList" parameterType="com.ssafy.bbb.model.dto.notice.PostSearchDto" resultType="com.ssafy.bbb.model.dto.notice.PostListDto">
  		SELECT p.post_id, u.name, p.title, p.sido_nm, p.sgg_nm, p.view_cnt, p.created_at, p.last_modified_at
  		FROM posts p
  		LEFT JOIN users u ON p.user_id = u.user_id
  		<where>
  			<include refid="searchCondition" />
  		</where>
  		ORDER BY p.created_at DESC
  		LIMIT #{limit} OFFSET #{offset}
  	</select>
  	
  	<select id="postCount">
  		SELECT COUNT(*)
  		FROM posts p
  		LEFT JOIN users u ON p.user_id = u.user_id
  		<where>
  			<include refid="searchCondition"/>
  		</where>
  	</select>
  	
  	<select id="postDetail" resultType="com.ssafy.bbb.model.dto.notice.PostDetailDto">
  		SELECT p.*, u.name
  		FROM posts p
  		LEFT JOIN users u ON p.user_id = u.user_id
  		WHERE p.post_id = #{postId}
  	</select>
  	
  	<update id="update" parameterType="com.ssafy.bbb.model.dto.notice.PostRequestDto">
  		UPDATE posts
  		<set>
  			title = #{title},
  			content = #{content},
  			sido_nm = #{sidoNm},
  			sgg_nm = #{sggNm},
  			last_modified_at = NOW()
  		</set>
  		WHERE post_id = #{postId}
  	</update>
  	
  	<delete id="delete">
  		DELETE FROM posts
  		WHERE post_id = #{postId}
  	</delete>
  	
  	<update id="updateViewCnt">
  		UPDATE posts
  		SET view_cnt = view_cnt + 1
  		WHERE post_id = #{postId}
  	</update>
  </mapper>